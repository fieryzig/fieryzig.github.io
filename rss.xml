<?xml version="1.0" encoding="utf-8"?>
<rss version="2.0">
<channel>
<title><![CDATA[Les Frites]]></title>
<description><![CDATA[Les Frites]]></description>
<link>https://fieryzig.github.io</link>
<lastBuildDate>Tue, 09 Mar 2021 01:35:03 +0000</lastBuildDate>
<item>
  <title><![CDATA[一篇来自手机的博客]]></title>
  <description><![CDATA[
<p>
测试一下手机发博客。如果成功的话，下一篇讲一下原理。
</p>
<div class="taglist"></div>]]></description>
  <link>https://fieryzig.github.io/一篇来自手机的博客.html</link>
  <pubDate>Mon, 08 Mar 2021 23:59:00 +0000</pubDate>
</item>
<item>
  <title><![CDATA[关于dashboard中recent files的问题]]></title>
  <description><![CDATA[
<p>
最近在使用dashboard的时候，发现了一个不完美的地方，就是经常发现Recent Files里面会出现Org Agenda相关的文件。这些文件占据了Recent Files的位置，导致无法显示出我真正想要的最近文件。
搜索了一下，发现<a href="https://github.com/emacs-dashboard/emacs-dashboard">dashboard</a>的issues里面已经有了相关的问题，并且！已经有<a href="https://github.com/emacs-dashboard/emacs-dashboard/pull/83">PR</a>修复了这个问题！
看来事情并不是这么简单。
</p>

<div id="outline-container-org5337545" class="outline-2">
<h2 id="org5337545">问题的复现</h2>
<div class="outline-text-2" id="text-org5337545">
<p>
因为自己只是在日常使用中经常遇到这个问题，并没有留意发生的条件，所以问题的第一步是复现这个问题。
</p>

<p>
首先发现重新启动Emacs显示的结果是正确的（Recent Files里面没有Org文件）
</p>

<p>
由于我的Emacs里面配置了 <code>tempbuf</code> ，所以10s钟后会自动kill掉org的buffer。
</p>

<p>
经过多次实验，我发现，10s前我在dashboard按 <code>g</code> ，刷新dashboard，显示正确。但是10s后（即org buffer被kill后），Recent Files里面就会出现Org文件。
</p>

<p>
一个问题此时变成了多个问题：
</p>

<ul class="org-ul">
<li>为什么org buffer被kill后，刷新dashboard会显示错误？</li>
<li>为什么启动Emacs又是正确的？</li>
<li>怎么解决这个问题？怎么让dashboard一直显示正确？</li>
</ul>
</div>
</div>

<div id="outline-container-orga7e738a" class="outline-2">
<h2 id="orga7e738a">继续探究</h2>
<div class="outline-text-2" id="text-orga7e738a">
</div>
<div id="outline-container-orga9a50d3" class="outline-3">
<h3 id="orga9a50d3">从dashboard出发</h3>
<div class="outline-text-3" id="text-orga9a50d3">
<p>
dashboard照理说已经修复了这个问题，我们先来看看PR83究竟是怎么修复的。
重点就在 <code>dashboard-insert-startupify-lists</code> 这个函数里
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span style="font-weight: bold;">defun</span> <span style="font-weight: bold;">dashboard-insert-startupify-lists</span> ()
  <span style="font-style: italic;">"Insert the list of widgets into the buffer."</span>
  (<span style="font-weight: bold;">interactive</span>)
  (<span style="font-weight: bold;">let</span> ((buffer-exists (buffer-live-p (get-buffer dashboard-buffer-name)))
        (recentf-is-on (recentf-enabled-p))
        (origial-recentf-list recentf-list)
        (dashboard-num-recents (<span style="font-weight: bold;">or</span> (cdr (assoc 'recents dashboard-items)) 0))
        (max-line-length 0))
    <span style="font-weight: bold; font-style: italic;">;; </span><span style="font-weight: bold; font-style: italic;">disable recentf mode,</span>
    <span style="font-weight: bold; font-style: italic;">;; </span><span style="font-weight: bold; font-style: italic;">so we don't flood the recent files list with org mode files</span>
    <span style="font-weight: bold; font-style: italic;">;; </span><span style="font-weight: bold; font-style: italic;">do this by making a copy of the part of the list we'll use</span>
    <span style="font-weight: bold; font-style: italic;">;; </span><span style="font-weight: bold; font-style: italic;">let dashboard widgets change that</span>
    <span style="font-weight: bold; font-style: italic;">;; </span><span style="font-weight: bold; font-style: italic;">then restore the orginal list afterwards</span>
    <span style="font-weight: bold; font-style: italic;">;; </span><span style="font-weight: bold; font-style: italic;">(this avoids many saves/loads that would result from</span>
    <span style="font-weight: bold; font-style: italic;">;; </span><span style="font-weight: bold; font-style: italic;">disabling/enabling recentf-mode)</span>
    (<span style="font-weight: bold;">when</span> recentf-is-on
      (<span style="font-weight: bold;">setq</span> recentf-list (seq-take recentf-list dashboard-num-recents)))
    (<span style="font-weight: bold;">when</span> (<span style="font-weight: bold;">or</span> (not (eq dashboard-buffer-last-width (window-width)))
              (not buffer-exists))
      (<span style="font-weight: bold;">setq</span> dashboard-banner-length (window-width)
            dashboard-buffer-last-width dashboard-banner-length)
      (<span style="font-weight: bold;">with-current-buffer</span> (get-buffer-create dashboard-buffer-name)
        (<span style="font-weight: bold;">let</span> ((buffer-read-only nil))
          (erase-buffer)
          (dashboard-insert-banner)
          (dashboard-insert-page-break)
          (<span style="font-weight: bold;">setq</span> dashboard--section-starts nil)
          (mapc (<span style="font-weight: bold;">lambda</span> (els)
                  (<span style="font-weight: bold;">let*</span> ((el (<span style="font-weight: bold;">or</span> (car-safe els) els))
                         (list-size
                          (<span style="font-weight: bold;">or</span> (cdr-safe els)
                              dashboard-items-default-length))
                         (item-generator
                          (cdr-safe (assoc el dashboard-item-generators))))
                    (add-to-list 'dashboard--section-starts (point))
                    (funcall item-generator list-size)
                    (<span style="font-weight: bold;">when</span> recentf-is-on
                      (<span style="font-weight: bold;">setq</span> recentf-list origial-recentf-list))
                    (<span style="font-weight: bold;">setq</span> max-line-length
                          (max max-line-length (dashboard-maximum-section-length)))
                    (dashboard-insert-page-break)))
                dashboard-items)
          (<span style="font-weight: bold;">when</span> dashboard-center-content
            (<span style="font-weight: bold;">when</span> dashboard--section-starts
              (goto-char (car (last dashboard--section-starts))))
            (<span style="font-weight: bold;">let</span> ((margin (floor (/ (max (- (window-width) max-line-length) 0) 2))))
              (<span style="font-weight: bold;">while</span> (not (eobp))
                (<span style="font-weight: bold;">unless</span> (string-suffix-p (thing-at-point 'line) dashboard-page-separator)
                  (insert (make-string margin ?\ )))
                (forward-line 1))))
          (dashboard-insert-footer))
        (goto-char (point-min))
        (dashboard-mode)))
    (<span style="font-weight: bold;">when</span> recentf-is-on
      (<span style="font-weight: bold;">setq</span> recentf-list origial-recentf-list))))
</pre>
</div>

<p>
从中间的注释中可以看出，是先用 <code>origial-recentf-list</code> 将 <code>recentf-list</code> 记录下来，在最后再复原回去。
</p>

<p>
看起来好像没什么不对的。但是既然不对了，说明一定是 <code>recentf-list</code> 这个变量出了问题。并且 <code>kill-buffer</code> 之前没问题， <code>kill-buffer</code> 之后出了问题，是不是 <code>kill-buffer</code> 的时候改变了 <code>recentf-list</code> 呢
</p>
</div>
</div>

<div id="outline-container-org21ea38f" class="outline-3">
<h3 id="org21ea38f">到recentf中去</h3>
<div class="outline-text-3" id="text-org21ea38f">
<p>
<a href="https://gitlab.com/basil-conto/emacs/blob/master/lisp/recentf.el#L1030">点这里</a>看recentf源码
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span style="font-weight: bold;">defconst</span> <span style="font-weight: bold; font-style: italic;">recentf-used-hooks</span>
  '(
    (find-file-hook       recentf-track-opened-file)
    (write-file-functions recentf-track-opened-file)
    (kill-buffer-hook     recentf-track-closed-file)
    (kill-emacs-hook      recentf-save-list)
    )
  <span style="font-style: italic;">"Hooks used by recentf."</span>)
</pre>
</div>

<p>
从这里可以看出它的逻辑是 <code>find-file</code> 和 <code>write-file</code> 的时候，将文件放入 <code>recentf-list</code> 中； <code>kill-buffer</code> 的时候将文件从 <code>recentf-list</code> 中删除；退出Emacs的时候将 <code>recentf-list</code> 写入文件。
</p>

<p>
看来这里也没什么问题。那问题究竟出在哪里？
</p>
</div>
</div>

<div id="outline-container-org8b0fde6" class="outline-3">
<h3 id="org8b0fde6">一个猜想</h3>
<div class="outline-text-3" id="text-org8b0fde6">
<p>
先不考虑第一次启动Emacs的话，问题变得简单了一些。存在org文件buffer的时候，刷新dashbaord没问题。不存在org文件buffer的时候，刷新dashboard就会出错。所以，一定是刷新dashbaord的时候，agenda会打开org文件，如果org文件已经在buffer中了，就不会 <code>find-file</code> ；否则调用 <code>find-file</code> 就会触发 <code>recentf-track-opened-file</code> ，将文件加入到 <code>recentf-list</code> 中。
</p>

<p>
但是每次在刷新dashboard之后（无论是否正确），我将 <code>recentf-list</code> 打印出来，结果都是不包含org文件的。这应该是dashboard刷新后，用之前的origial的复原了 <code>recentf-list</code> 。
</p>

<p>
也就是 <code>recentf-list</code> 刷新之前和刷新之后都是好的。而最终展现的Recent Files却是错的。
</p>

<p>
真相只有一个了，那就是生成Recent Files的时候，用的 <code>recentf-list</code> 是错的。
</p>
</div>
</div>

<div id="outline-container-org4ca7e45" class="outline-3">
<h3 id="org4ca7e45">深入dashboard-widgets</h3>
<div class="outline-text-3" id="text-org4ca7e45">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span style="font-weight: bold;">defun</span> <span style="font-weight: bold;">dashboard-insert-recents</span> (list-size)
  <span style="font-style: italic;">"Add the list of LIST-SIZE items from recently edited files."</span>
  (<span style="font-weight: bold;">setq</span> dashboard--recentf-cache-item-format nil)
  (recentf-mode)
  (<span style="font-weight: bold;">let</span> ((inhibit-message t) (message-log-max nil))
    (recentf-cleanup))
  (dashboard-insert-section
   <span style="font-style: italic;">"Recent Files:"</span>
   (dashboard-shorten-paths recentf-list 'dashboard-recentf-alist)
   list-size
   (dashboard-get-shortcut 'recents)
   `(<span style="font-weight: bold;">lambda</span> (<span style="font-weight: bold; text-decoration: underline;">&amp;rest</span> ignore)
      (find-file-existing (dashboard-expand-path-alist ,el dashboard-recentf-alist)))
   (<span style="font-weight: bold;">let*</span> ((file (dashboard-expand-path-alist el dashboard-recentf-alist))
          (filename (dashboard-f-filename file))
          (path (dashboard-extract-key-path-alist el dashboard-recentf-alist)))
     (<span style="font-weight: bold;">cl-case</span> dashboard-recentf-show-base
       (align
        (<span style="font-weight: bold;">unless</span> dashboard--recentf-cache-item-format
          (<span style="font-weight: bold;">let*</span> ((len-align (dashboard--get-align-length dashboard-recentf-alist))
                 (new-fmt (dashboard--generate-align-format
                           dashboard-recentf-item-format len-align)))
            (<span style="font-weight: bold;">setq</span> dashboard--recentf-cache-item-format new-fmt)))
        (format dashboard--recentf-cache-item-format filename path))
       (nil (format dashboard-recentf-item-format filename path))
       (t path)))))
</pre>
</div>

<p>
在这里我们终于发现 <code>recentf-list</code> 。而这时的 <code>recentf-list</code> 应该是没有复原过的。所以才会输出错误的结果。
</p>

<p>
在这里，我们还注意到 <code>(recentf-mode)</code> 。也就是说 <code>recentf-mode</code> 是在这里启动的。这也是为什么重新启动Emacs显示正确的原因。因为dashboard先处理Agenda的org文件，此时还没有开启recentf-mode，所以结果是对的。
</p>

<p>
为了验证这一点，我将 <code>dashbaord-items</code> 里面的顺序调整了一下，把recentf放在agenda的前面。果然，再次启动Emacs，结果也是错误的。
</p>
</div>
</div>
</div>

<div id="outline-container-orgb22a24b" class="outline-2">
<h2 id="orgb22a24b">结论</h2>
<div class="outline-text-2" id="text-orgb22a24b">
<p>
所以，这个<a href="https://github.com/emacs-dashboard/emacs-dashboard/pull/83/">PR</a>压根没有修复Recent Files显示Agenda org files这个issue。它只在同时满足 <b>首次启动Emacs</b> 和 <b>agenda在recentf前面</b> 这两个条件时，它才会Work。
</p>

<p>
最后说一下我的解决方案：
</p>
</div>

<div id="outline-container-orgf182bc3" class="outline-3">
<h3 id="orgf182bc3">1.修改dashboard的逻辑</h3>
<div class="outline-text-3" id="text-orgf182bc3">
<p>
在上面dashboard的代码中加两行，作用是每次完成一个item之后，都复原一次 <code>recentf-list</code> 。
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(mapc (<span style="font-weight: bold;">lambda</span> (els)
        (<span style="font-weight: bold;">let*</span> ((el (<span style="font-weight: bold;">or</span> (car-safe els) els))
               (list-size
                (<span style="font-weight: bold;">or</span> (cdr-safe els)
                    dashboard-items-default-length))
               (item-generator
                (cdr-safe (assoc el dashboard-item-generators))))
          (add-to-list 'dashboard--section-starts (point))
          (funcall item-generator list-size)
          (<span style="font-weight: bold;">when</span> recentf-is-on
            (<span style="font-weight: bold;">setq</span> recentf-list origial-recentf-list))
          (<span style="font-weight: bold;">setq</span> max-line-length
                (max max-line-length (dashboard-maximum-section-length)))
          (dashboard-insert-page-break)))
      dashboard-items)
</pre>
</div>
<p>
这个方法，好处是简单容易，效率高，缺点是修改了dashboard，在代码没被合到master之前会比较难受。
</p>
</div>
</div>

<div id="outline-container-orgd7ad1d2" class="outline-3">
<h3 id="orgd7ad1d2">2.重新定义g按键</h3>
<div class="outline-text-3" id="text-orgd7ad1d2">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(define-key dashboard-mode-map (kbd <span style="font-style: italic;">"g"</span>) #'my-dashboard-g)
</pre>
</div>

<p>
<code>my-dashboard-g</code> 的实现有两种思路，一是在refresh之前，把recentf-mode关闭了。这个方法的缺点在上面的PR里面的注释里说道了，就是读写文件，效率差。二是直接refresh两次，因为第一次refresh的时候org文件的buffer是不在的，所以错了，第二次时org文件的buffer的文件还在，因此结果是正确的。
</p>

<p>
重新定义g按键的方法，并没有修复问题，只是看起来ok的trick，并且只能agenda在recentf的前面。
</p>

<p>
因此还是推荐第1种做法，改日有时间提个PR吧。
</p>
</div>
</div>
</div>
<div class="taglist"><a href="https://fieryzig.github.io/tags.html">Tags</a>: <a href="https://fieryzig.github.io/tag-emacs.html">Emacs</a> </div>]]></description>
  <category><![CDATA[Emacs]]></category>
  <link>https://fieryzig.github.io/2021-03-06-关于dashboard中recent-files的问题.html</link>
  <pubDate>Sat, 06 Mar 2021 18:35:00 +0000</pubDate>
</item>
<item>
  <title><![CDATA[来自Org的第一篇文章]]></title>
  <description><![CDATA[
<p>
这是一篇用Emacs和Org编写的博客。
</p>

<div id="outline-container-orgb39555e" class="outline-2">
<h2 id="orgb39555e">缘起</h2>
<div class="outline-text-2" id="text-orgb39555e">
<p>
最近突然想写博客了，其实之前也断断续续的写过一些，从一开始的CSDN到Github Pages，从pelican到hugo。
</p>

<p>
但是我感觉这些并不适合我。所以我有了一段用纸和笔手写博客的时光。随心所欲的写写画画，一切都是那么简单。
</p>

<p>
然后中间略过一些事情。
</p>

<p>
快进到我突然想写博客了。
</p>

<p>
因为我平时一直在用Emacs，所以我选择的范围缩小到了<a href="https://orgmode.org/worg/org-blog-wiki.html">这么大</a>。
</p>

<p>
试用过ox-hugo，感觉太麻烦了。
</p>

<p>
最终，忙里偷闲，在Emacs上配了<a href="https://github.com/bastibe/org-static-blog">org-static-blog</a>。
</p>
</div>
</div>

<div id="outline-container-orgbc78009" class="outline-2">
<h2 id="orgbc78009">org-static-blog</h2>
<div class="outline-text-2" id="text-orgbc78009">
<p>
这个博客生成工具给我的感觉就是simple and brute force。
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(use-package org-static-blog
  <span style="font-weight: bold;">:bind</span>
  (<span style="font-style: italic;">"C-c b n"</span> . org-static-blog-create-new-post)
  (<span style="font-style: italic;">"C-c b p"</span> . org-static-blog-publish)
  <span style="font-weight: bold;">:custom</span>
  (org-static-blog-publish-title fiery-blog-title)
  (org-static-blog-publish-url fiery-blog-url)
  (org-static-blog-publish-directory fiery-blog-directory)
  (org-static-blog-posts-directory (concat fiery-blog-directory <span style="font-style: italic;">"posts/"</span>))
  (org-static-blog-drafts-directory (concat fiery-blog-directory <span style="font-style: italic;">"drafts/"</span>))
  (org-static-blog-enable-tags t)
  (org-static-blog-use-preview t)
  (org-export-with-toc nil)
  (org-export-with-section-numbers nil)
  (org-static-blog-page-header
   <span style="font-style: italic;">"&lt;meta name=\"author\" content=\"fieryzig\"&gt;</span>
<span style="font-style: italic;">&lt;meta name=\"referrer\" content=\"no-referrer\"&gt;</span>
<span style="font-style: italic;">&lt;link href=\"static/style.css\" rel=\"stylesheet\" type=\"text/css\" /&gt;</span>
<span style="font-style: italic;">"</span>)
  (org-static-blog-page-preamble
   <span style="font-style: italic;">"&lt;div class=\"header\"&gt;</span>
<span style="font-style: italic;">&lt;h1 class=\"title\"&gt;&lt;a href=\"https://fieryzig.github.io\"&gt;fieryzig&lt;/a&gt;&lt;/h1&gt;</span>
<span style="font-style: italic;">&lt;p class=\"text-muted\"&gt;fieryzig's blog&lt;/p&gt;</span>
<span style="font-style: italic;">&lt;ul class=\"list-inline\"&gt;</span>
<span style="font-style: italic;">&lt;li class=\"list-inline-item\"&gt;&lt;a href=\"https://fieryzig.github.io\"&gt;About&lt;/a&gt;&lt;/li&gt;</span>
<span style="font-style: italic;">&lt;/ul&gt;</span>
<span style="font-style: italic;">&lt;/div&gt;"</span>)
  (org-static-blog-page-postamble <span style="font-style: italic;">""</span>))
</pre>
</div>

<p>
因为不太擅长前端（HTML/CSS/JS），所以现在还很简陋，之后会逐渐完善的。
</p>
</div>
</div>

<div id="outline-container-org3e4adac" class="outline-2">
<h2 id="org3e4adac">结语</h2>
<div class="outline-text-2" id="text-org3e4adac">
<p>
最后立个flag，讲讲之后博客上会写些什么。
</p>

<ul class="org-ul">
<li>2020年是我比较复杂的一年，我想写写我关于2020年的回忆，以及2020年完成的和未完成的一些东西</li>
<li>自己之后学习的一些笔记
<ul class="org-ul">
<li>游戏开发</li>
<li>图形学/渲染</li>
<li>Emacs</li>
<li>厨艺？</li>
<li>其他好玩的东西</li>
</ul></li>
<li>日常生活的感悟和吐槽</li>
</ul>
</div>
</div>
<div class="taglist"><a href="https://fieryzig.github.io/tags.html">Tags</a>: <a href="https://fieryzig.github.io/tag-emacs.html">Emacs</a> <a href="https://fieryzig.github.io/tag-life.html">life</a> </div>]]></description>
  <category><![CDATA[Emacs]]></category>
  <category><![CDATA[life]]></category>
  <link>https://fieryzig.github.io/2021-03-04-来自org的第一篇文章.html</link>
  <pubDate>Thu, 04 Mar 2021 19:09:00 +0000</pubDate>
</item>
</channel>
</rss>
